{% extends "cloth/layout.html" %}
{% load math_filters %}

{% block home_page %}
<a class="navbar-brand" href="{% url 'model_list_view' %}">HONEST PRODUCTION</a>
{% endblock %}

{% block navbar_links_large %}
{% include "production/nav_links.html" %}
{% endblock %}

{% block navbar_links_small %}
{% include "production/nav_links.html" %}
{% endblock %}

{% block body %}
<form method="post" id="productionForm">
    {% csrf_token %}
    <label for="id_model">اختر الموديل:</label>
    <select id="id_model" name="model">
        <option value="">-- اختر الموديل --</option>
        {% for model in form.fields.model.queryset %}
        <option value="{{ model.id }}">{{ model }}</option>
        {% endfor %}
    </select>

    <label for="id_size_amount">اختر المقاس والكمية:</label>
    <select id="id_size_amount" name="size_amount">
        <option value="">-- اختر المقاس --</option>
    </select>

    <label for="id_piece">اختر القطعة:</label>
    <select id="id_piece" name="piece">
        <option value="">-- اختر القطعة --</option>
    </select>

    <label for="id_used_amount">الكمية المراد استخدامها:</label>
    <input type="number" id="id_used_amount" name="used_amount" min="1">

    <button type="submit">إرسال</button>
</form>
    
{% endblock body %}

{% block script %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        $("#id_model").change(function () {
            let modelId = $(this).val();
            if (modelId) {
                $.ajax({
                    url: "{% url 'load_sizes' %}",
                    data: { model_id: modelId },
                    success: function (data) {
                        $("#id_size_amount").empty().append('<option value="">-- اختر المقاس --</option>');
                        $.each(data.sizes, function (index, item) {
                            $("#id_size_amount").append('<option value="' + item.id + '">' + item.size + ' (' + item.amount + ' متاحة)</option>');
                        });
                    }
                });
            }
        });

        $("#id_size_amount").change(function () {
            let sizeAmountId = $(this).val();
            if (sizeAmountId) {
                $.ajax({
                    url: "{% url 'load_pieces' %}",
                    data: { size_amount_id: sizeAmountId },
                    success: function (data) {
                        $("#id_piece").empty().append('<option value="">-- اختر القطعة --</option>');
                        $.each(data.pieces, function (index, item) {
                            $("#id_piece").append('<option value="' + item.id + '">' + item.type + ' (' + item.available_amount + ' متاحة)</option>');
                        });
                    }
                });
            }
        });
    });
</script>

{% endblock script %}
